#!/usr/bin/env node
var io    = require('socket.io').listen(8080)
  , scale = require('dymo-scale')
  , exec  = require('child_process').exec
  , fs    = require('fs');

io.sockets.on('connection', function(socket) {
  setInterval(function() {
    if(res = scale.poll()) {
      socket.emit(res.value);
    }
  }, 250);

  socket.on('printer', function(data) {
    var path = '/tmp/' + new Date().getTime();

    fs.writeFile(path, data, function(err) {
      if(err) return;

      exec('lpr -l ' + path, function() {
        fs.unlink(path);
      });
    });
  });
});
